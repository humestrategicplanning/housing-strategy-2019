<!DOCTYPE html>
<html>
<head>
  <meta charset='utf-8' />
  <title>Local search app</title>
  <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
  <script src='https://api.mapbox.com/mapbox-gl-js/v1.0.0/mapbox-gl.js'></script>
  <link href='https://api.mapbox.com/mapbox-gl-js/v1.0.0/mapbox-gl.css' rel='stylesheet' />
  <script src='https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v4.2.0/mapbox-gl-geocoder.min.js'></script>
  <link rel='stylesheet' href='https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v4.2.0/mapbox-gl-geocoder.css' type='text/css' />
  <script src='https://npmcdn.com/@turf/turf/turf.js'></script>
  <script
  src="https://code.jquery.com/jquery-3.4.1.min.js"
  integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo="
  crossorigin="anonymous"></script>
  <script src="https://d3js.org/d3.v5.js"></script>
  <style>
    body {
      margin: 0;
      padding: 0;
    }

    #map {
      position: absolute;
      top: 0;
      bottom: 0;
      width: 100%;
    }
    
    .mapboxgl-ctrl-geocoder {
      min-width: 300px;
    }
    
    .category {
      font-family: 'Roboto Medium', roboto, Arial, sans-serif;
      font-size: 14px;
      font-weight: 600;
    }
    
    .control {
      border-radius: 3px;
      box-shadow: 0 1px 2px rgba(0,0,0,0.10);
      z-index: 1;
    }
    
    .desc-box {
      margin: 0 auto;
    }
    
    .title {
      font-family: 'Roboto Medium', roboto, Arial, sans-serif;
      position: absolute;
      left: 10px;
      top: 10px;
      background-color: rgba(255, 255, 255, 0.9);
    }
    
    .title h1 {
      padding: 15px;
      margin: 0 0 0 0;
    }
    
    .legend {
      font: 12px/20px 'Roboto Medium', roboto, Arial, sans-serif;
      padding: 20px;
      position: absolute;
      right: 10px;
      bottom: 30px;
      background-color: rgba(255, 255, 255, 0.8);
    }
    
    .legend h3 {
      margin: 5px 0 2px;
      font-size: 1.1em;
    }
    
    .legend h2 {
      margin: 0 0 5px;
    }
    
    .leg-line {
      display: flex;
      align-items: center;
    }
    
    .circle {
      border: 1px solid black;
      border-radius: 50%;
      display: inline-block;
      height: 12px;
      margin-right: 5px;
      width: 12px;
    }
    
    .line {
      margin-right: 5px;
      width: 18px;
      height:4px;
      background: repeating-linear-gradient(to right,#D00C0C 0,#D00C0C 5px,transparent 5px,transparent 7px);
    }
    
    #style-select {
      margin-top: 10px;
    }
    
  </style>
</head>
<body>

  <div id='map'></div>
  
  <div class='control title'>
    <h1>Hume Housing Strategy</h1>
  </div>
  
  <div class='control legend'>
    <h2>Legend</h2>
    <div class='leg-line'><span class='line'></span>Hume Boundary</div>
    <h3>Housing Category</h3>
    <div class='leg-line'><span class="circle" style='background-color: #FFCE19'></span>High Change</div>
    <div class='leg-line'><span class="circle" style='background-color: #BF56A7'></span>Moderate Change</div>
    <div class='leg-line'><span class="circle" style='background-color: #8C96C6'></span>Gradual Change</div>
    <div class='leg-line'><span class="circle" style='background-color: #BFD3E6'></span>Limited Change</div>
    
    <div id='style-select'>
      <input id='cjzi0ohe13l4f1cpclaxbjt82' type='radio' name='rtoggle' value='light' checked />
      <label for='light'>light</label>
      <input id='cjzi0p1px3kzr1cpe2tewy9fp' type='radio' name='rtoggle' value='streets' />
      <label for='streets'>streets</label>
    </div>
  </div>
  
<script>
  
  const changeAreaColors = {
    limited: '#BFD3E6',
    gradual: '#8C96C6',
    moderate: '#BF56A7',
    high: '#FFCE19'
  };
  
  const changeAreaDesc = [
    "Limited Change Description Here",
    "Gradual Change Description Here",
    "Moderate Change Description Here",
    "High Change Description Here"
  ];
  
  const changeAreaNames = ['Limited Change', 'Gradual Change', 'Moderate Change', 'High Change'];

  const changeAreaPath = './data/change-areas-v4.geojson';
  const strategicSitesPath = './data/strategic-sites-v1.geojson';
  
  const humeBbox = [144.632482, -37.712416, 144.977766, -37.481958];
  const housingOpacity = 0.7;
  const bounds = [
    [144.372711,-37.839072], [145.3,-37.379979]
  ];
  
  function openDescription() {
    document.getElementById('map').innerHTML = '<div class="control desc-box">"TEST"</div>';
  }
  
  mapboxgl.accessToken= 'pk.eyJ1IjoiaHVtZXN0cmF0ZWdpY3BsYW5uaW5nIiwiYSI6ImNqeGswZWJpbzFrNGgzeW9qZGZmcDNqZGcifQ.5VOjZz6s1CYrJwo4LKiD0Q';//'pk.eyJ1IjoiYmlza3dpa21hbiIsImEiOiJjaWxidzVlcGQxcmtxdWJrbjQ2Zng3bWN5In0.KcfLaovMGcEZkl6cyU6_Hw';
  var map = new mapboxgl.Map({
    container: 'map',
    style: 'mapbox://styles/humestrategicplanning/cjzi0ohe13l4f1cpclaxbjt82',//'mapbox://styles/biskwikman/cjwbe97kt1cao1cl6h3ywigtp',
    center: [144.850, -37.600],
    zoom: 9,
    maxBounds: bounds
  });
  
  map.fitBounds([[144.632482, -37.712416], [144.977766, -37.481958]], {padding: 20});
  
  
  
  //geocoder stuff
  const geocoder = new MapboxGeocoder({ // Initialize the geocoder
  accessToken: mapboxgl.accessToken, // Set the access token
  mapboxgl: mapboxgl, // Set the mapbox-gl instance
  marker: true, //use the default marker style
  placeholder: 'Search for an address in Hume...',
  types: 'address',
  bbox: humeBbox,
  clearOnBlur: true
  });
  
  

  // Add the geocoder to the map
  map.addControl(geocoder);
  
  //add hume boundary
  map.on("load", function() {
    
  //get index of first symbol layer in map style
  var layers = map.getStyle().layers;
  var firstSymbolId;
  for (var i = 0; i < layers.length; i++) {
    if (layers[i].type === 'symbol') {
      firstSymbolId = layers[i].id;
      break;
    }
  }
    
    //add geojson data
    function addData() {
      map.addLayer({
      'id': 'hume',
      'type': 'line',
      'source': {
        'type': 'geojson',
        'data': 'data/hume-geo.geojson'
      },
      'layout': {
        'line-join': 'round',
        'line-cap': 'round'
      },
      'paint': {
        'line-color': '#D00C0C',
        'line-width': 4,
        'line-dasharray': [3, 2],
      }
    }, firstSymbolId)
    
    map.addSource('changeAreas', {
      type: 'geojson',
      data: changeAreaPath
    });
    
    map.addSource('strategicSites', {
      type: 'geojson',
      data: strategicSitesPath
    });
      
    //add geojson data to map and style fills
    map.addLayer({
      'source': 'changeAreas',
      'id': 'areas',
      'type': 'fill',
      'paint': {
        'fill-color': [
          'match',
          ['get', 'Category'],
          'Limited Change', changeAreaColors.limited, //'#FFB0BA'
          'Gradual Change', changeAreaColors.gradual, //'#D1D1FA'
          'Moderate Change', changeAreaColors.moderate, //'#A394FA'
          'High Change', changeAreaColors.high, //'#5E1BF2'
          '#fff'
        ],
        'fill-opacity': housingOpacity
      }
    }, firstSymbolId);
    
    map.addLayer({
      'source': 'changeAreas',
      'id': 'area-boundaries',
      'type': 'line',
      'paint': {
        'line-color': 'black',
        'line-opacity': 0.5
      }
    }, firstSymbolId);
    }
    addData();
    
    // Change map baselayer (style)
    const layerList = document.getElementById('style-select');
    const inputs = layerList.getElementsByTagName('input');
    
    function switchLayer(layer) {
      const layerId = layer.target.id;
      map.setStyle('mapbox://styles/humestrategicplanning/' + layerId);
      map.on('style.load', function() {
        addData();
      })
    }
    
    for (let i = 0; i < inputs.length; i++) {
      inputs[i].onchange = switchLayer;
    }
    
    //add hatch pattern to strategic site
    /*map.loadImage('./data/hatch.png', function(err, image) {
      if (err) throw err;
      
      map.addImage('pattern', image);
    
    map.addLayer({
      'source': 'strategicSites',
      'id': 'sites-fill',
      'type': 'fill',
      'paint': {
        'fill-pattern': 'pattern',
        'fill-opacity': 0.8
      }
    }, firstSymbolId);
    });
    
    map.addLayer({
      'source': 'strategicSites',
      'id': 'sites-boundary',
      'type': 'line',
      'paint': {
        'line-color': 'yellow',
        'line-opacity': 0.8,
        'line-width': 4
      }
    }, firstSymbolId);
    */
    
    //search for address and create popup based on location
    fetch('data/change-areas.geojson').then(response => response.json())
      .then(data => {
        geocoder.on('result', function() {
          const geocoderLng = geocoder.mapMarker._lngLat.lng;
          const geocoderLat = geocoder.mapMarker._lngLat.lat;
          const searchedMarker = turf.point([geocoderLng, geocoderLat]);
          let inArea = false;
          console.log(searchedMarker);
          for (f=0; f<data.features.length; f++) {
            if (turf.booleanPointInPolygon(searchedMarker, data.features[f]) == true) {
              inArea = true;
              const searchedInsidePopup = new mapboxgl.Popup({anchor: 'top'})
              .setLngLat(geocoder.mapMarker._lngLat)
              .setHTML('<b class="category">'+data.features[f].properties.Category+'</b>'+'<div class="info">'+'For more information, <a class="desc-click" href="pdf/test.pdf">click here.</a>'+'</div>')
              .addTo(map)
              //clear if not in polygon as well
              window.onclick = function() {
                geocoder.clear()
              }
              geocoder.on('loading', function() {
                searchedInsidePopup.remove()
              })
            }
          }
          if (inArea == false) {
            const searchPopup = new mapboxgl.Popup({anchor: 'top'})
            .setLngLat(geocoder.mapMarker._lngLat)
            .setHTML('<b class="category">'+'Not in a Change Area'+'</b>'+'<br/>'+'<div class="info">'+'For more information, <a href="pdf/test.pdf">click here.</a>'+'</div>')
            .addTo(map)
            window.onclick = function() {
              geocoder.clear()
            }
            geocoder.on('loading', function() {
              searchPopup.remove()
            })
          }
        });
      });
    
    //make a popup
    map.on('click', 'areas', function(e) {
        const category = e.features[0].properties.Category;
        for (i=0; i<changeAreaNames.length; i++) {
          if (category == changeAreaNames[i]) {
          new mapboxgl.Popup()
              .setLngLat(e.lngLat)
              .setHTML('<b class="category">'+category+'</b>' + '<div class="info">'+changeAreaDesc[i]+'<br/>'+'For more information, <a class="desc-click" onclick="openDescription()">click here.</a>'+'</div>')
              .addTo(map);
          }
        }
    });
    
    map.on('mouseenter', 'areas', function () {
      map.getCanvas().style.cursor = 'pointer';
    });
      
    map.on('mouseleave', 'areas', function () {
      map.getCanvas().style.cursor = '';
    });
  });
</script>

</body>
</html>
